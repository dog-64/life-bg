#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è Conway's Game of Life –≤ Docker
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh [--clean] [--no-cache]

CLEAN_IMAGES=false
NO_CACHE=false

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
while [[ $# -gt 0 ]]; do
  case $1 in
    --clean)
      CLEAN_IMAGES=true
      shift
      ;;
    --no-cache)
      NO_CACHE=true
      shift
      ;;
    -h|--help)
      echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [--clean] [--no-cache]"
      echo "  --clean     –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π"
      echo "  --no-cache  –°–æ–±—Ä–∞—Ç—å –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞"
      echo "  --help      –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
      exit 0
      ;;
    *)
      echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1"
      echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
      exit 1
      ;;
  esac
done

echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è Conway's Game of Life..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ñ–ª–∞–≥ --clean
if [ "$CLEAN_IMAGES" = true ]; then
  echo "üóëÔ∏è  –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
  docker rmi $(docker images "life-gb*" -q) 2>/dev/null || true
  # –£–¥–∞–ª—è–µ–º —Ç–∞–∫–∂–µ dangling –æ–±—Ä–∞–∑—ã
  docker image prune -f
fi

# –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è)
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
if [ "$NO_CACHE" = true ]; then
  docker-compose build --no-cache
else
  docker-compose build
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
sleep 5
docker-compose ps

echo ""
echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –ò–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8000"
echo ""
echo "–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  docker-compose logs -f    # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "  docker-compose stop       # –û—Å—Ç–∞–Ω–æ–≤–∫–∞"
echo "  docker-compose restart    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo "  docker-compose down       # –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞"
echo ""
echo "–û–ø—Ü–∏–∏ –¥–µ–ø–ª–æ—è:"
echo "  ./deploy.sh --clean       # –î–µ–ø–ª–æ–π —Å –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤"
echo "  ./deploy.sh --no-cache    # –î–µ–ø–ª–æ–π –±–µ–∑ –∫—ç—à–∞ Docker"
echo "  ./deploy.sh --clean --no-cache  # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞" 